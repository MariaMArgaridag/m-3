from flask import Blueprint, request, jsonify
from app.service.security_vulnerability_service import SecurityVulnerabilityService
from app.repository.security_vulnerability_repository import SecurityVulnerabilityRepository
from app.database import db

# Blueprint: tudo o que estiver aqui começa com /security_vulnerabilities
security_vulnerability_bp = Blueprint(
    "security_vulnerabilities",
    __name__,
    url_prefix="/security_vulnerabilities"
)

# Liga Camada 1 -> Camada 2 (service) -> Camada 3 (repository)
service = SecurityVulnerabilityService(SecurityVulnerabilityRepository(db))


@security_vulnerability_bp.post("/")
def create_security_vulnerability():
    """
    Cria uma nova vulnerabilidade de segurança
    ---
    tags:
      - Security Vulnerabilities
    consumes:
      - application/json
    parameters:
      - in: body
        name: body
        required: true
        schema:
          type: object
          required:
            - vulnerability
          properties:
            vulnerability:
              type: string
              example: Weak Passwords
    responses:
      201:
        description: Vulnerabilidade criada
      400:
        description: Dados inválidos
    """
    data = request.json or {}

    vulnerability = data.get("vulnerability")

    if not vulnerability or not isinstance(vulnerability, str):
        return jsonify({"error": "Invalid vulnerability"}), 400

    created = service.create(vulnerability)
    return jsonify(created), 201


@security_vulnerability_bp.get("/")
def list_security_vulnerabilities():
    """
    Lista todas as vulnerabilidades de segurança
    ---
    tags:
      - Security Vulnerabilities
    responses:
      200:
        description: Lista de vulnerabilidades
    """
    return jsonify(service.list()), 200


@security_vulnerability_bp.get("/<int:id>")
def get_by_id_security_vulnerability(id):
    """
    Obtém uma vulnerabilidade pelo ID
    ---
    tags:
      - Security Vulnerabilities
    parameters:
      - in: path
        name: id
        required: true
        type: integer
        example: 1
    responses:
      200:
        description: Vulnerabilidade encontrada
      404:
        description: Não encontrada
    """
    result = service.get_by_id(id)

    if result is None:
        return jsonify({"error": "Not found"}), 404

    return jsonify(result), 200


@security_vulnerability_bp.put("/<int:id>")
def update_security_vulnerability(id):
    """
    Atualiza uma vulnerabilidade pelo ID
    ---
    tags:
      - Security Vulnerabilities
    consumes:
      - application/json
    parameters:
      - in: path
        name: id
        required: true
        type: integer
        example: 1
      - in: body
        name: body
        required: true
        schema:
          type: object
          required:
            - vulnerability
          properties:
            vulnerability:
              type: string
              example: Zero-day
    responses:
      200:
        description: Vulnerabilidade atualizada
      400:
        description: Dados inválidos
      404:
        description: Não encontrada
    """
    data = request.json or {}

    vulnerability = data.get("vulnerability")

    if not vulnerability or not isinstance(vulnerability, str):
        return jsonify({"error": "Invalid vulnerability"}), 400

    result = service.update(id, vulnerability)

    if result is None:
        return jsonify({"error": "Not found"}), 404

    return jsonify(result), 200


@security_vulnerability_bp.delete("/<int:id>")
def delete_security_vulnerability(id):
    """
    Apaga uma vulnerabilidade pelo ID
    ---
    tags:
      - Security Vulnerabilities
    parameters:
      - in: path
        name: id
        required: true
        type: integer
        example: 1
    responses:
      204:
        description: Apagada com sucesso
      404:
        description: Não encontrada
      409:
        description: Não pode ser apagada (FK)
    """
    result = service.delete(id)

    if result is False:
        return jsonify({"error": "Not found"}), 404

    if result == "FK":
        return jsonify({"error": "It cannot be deleted"}), 409

    return "", 204
