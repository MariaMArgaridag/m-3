import mysql.connector

class SecurityVulnerabilityRepository:
    def __init__(self, db):
        self.db = db

    def create(self, vulnerability: str):
        conn = self.db.get_connection()
        cursor = conn.cursor(dictionary=True)

        cursor.execute(
            "INSERT INTO Security_Vulnerabilities (vulnerability) VALUES (%s)",
            (vulnerability,)
        )

        conn.commit()

        return {
            "id": cursor.lastrowid,
            "vulnerability": vulnerability
        }

    def list(self):
        conn = self.db.get_connection()
        cursor = conn.cursor(dictionary=True)

        cursor.execute("SELECT * FROM Security_Vulnerabilities")
        return cursor.fetchall()
    
    def get_by_id(self, id: int):
        conn = self.db.get_connection()
        cursor = conn.cursor(dictionary=True)

        cursor.execute(
            "SELECT * FROM Security_Vulnerabilities WHERE id = %s",
            (id,)
        )

        return cursor.fetchone()
    
    def update(self, id: int, vulnerability: str):
        conn = self.db.get_connection()
        cursor = conn.cursor(dictionary=True)

        cursor.execute(
            "UPDATE Security_Vulnerabilities SET vulnerability = %s WHERE id = %s",
            (vulnerability, id)
        )

        if cursor.rowcount == 0:
            return None
        
        conn.commit()

        return {
            "id": id,
            "vulnerability": vulnerability
        }
    
    def delete(self, id: int):
        conn = self.db.get_connection()
        cursor = conn.cursor(dictionary=True)

        try:
            cursor.execute(
                "DELETE FROM Security_Vulnerabilities WHERE id = %s",
                (id,)
            )

            if cursor.rowcount == 0:
                return False

            conn.commit()
            return True

        except mysql.connector.Error as err:
            conn.rollback()

            if err.errno == 1451:
                return "FK"

            raise err