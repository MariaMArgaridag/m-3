from flask import Blueprint, request, jsonify
from service.security_vulnerability_service import SecurityVulnerabilityService
from repository.security_vulnerability_repository import SecurityVulnerabilityRepository
from database import db

security_vulnerability_bp = Blueprint("security_vulnerabilities", __name__, url_prefix="/security_vulnerabilities")
service = SecurityVulnerabilityService(SecurityVulnerabilityRepository(db))

@security_vulnerability_bp.post("/")
def create_security_vulnerability():
    """
    Criar nova vulnerabilidade de segurança
    ---
    tags:
      - SecurityVulnerabilities
    summary: "Create Security Vulnerability"
    description: "Registra uma nova vulnerabilidade de segurança no sistema"
    parameters:
      - in: body
        name: body
        required: true
        schema:
          type: object
          required:
            - vulnerability
          properties:
            vulnerability:
              type: string
              description: Nome ou descrição da vulnerabilidade
              example: "SQL Injection em formulário de login"
    responses:
      201:
        description: Vulnerabilidade criada com sucesso
        schema:
          type: object
          properties:
            id:
              type: string
            vulnerability:
              type: string
      400:
        description: Dados inválidos
        schema:
          type: object
          properties:
            error:
              type: string
    """
    data = request.json or {}

    vulnerability = data.get("vulnerability")

    if not vulnerability or not isinstance(vulnerability, str):
        return {"error": "Invalid vulnerability"}, 400

    return jsonify(
        service.create(vulnerability)
    ), 201

@security_vulnerability_bp.get("/")
def list_security_vulnerabilities():
    """
    Listar todas as vulnerabilidades de segurança
    ---
    tags:
      - SecurityVulnerabilities
    summary: "List All Security Vulnerabilities"
    description: "Retorna uma lista de todas as vulnerabilidades registradas"
    responses:
      200:
        description: Lista de vulnerabilidades
        schema:
          type: array
          items:
            type: object
            properties:
              id:
                type: string
              vulnerability:
                type: string
    """
    return jsonify(service.list())

@security_vulnerability_bp.get("/<string:external_id>")
def get_by_id_security_vulnerability(external_id):
    """
    Obter vulnerabilidade por ID
    ---
    tags:
      - SecurityVulnerabilities
    summary: "Read Security Vulnerability"
    description: "Retorna uma vulnerabilidade específica pelo seu ID"
    parameters:
      - in: path
        name: external_id
        type: string
        required: true
        description: ID único da vulnerabilidade
    responses:
      200:
        description: Vulnerabilidade encontrada
        schema:
          type: object
      404:
        description: Vulnerabilidade não encontrada
        schema:
          type: object
          properties:
            error:
              type: string
    """
    result = service.get_by_id(external_id)

    if result is None:
        return {"error": "Not found"}, 404

    return result

@security_vulnerability_bp.put("/<string:external_id>")
def update_security_vulnerability(external_id):
    """
    Atualizar vulnerabilidade de segurança
    ---
    tags:
      - SecurityVulnerabilities
    summary: "Update Security Vulnerability"
    description: "Atualiza as informações de uma vulnerabilidade existente"
    parameters:
      - in: path
        name: external_id
        type: string
        required: true
        description: ID único da vulnerabilidade
      - in: body
        name: body
        required: true
        schema:
          type: object
          required:
            - vulnerability
          properties:
            vulnerability:
              type: string
    responses:
      200:
        description: Vulnerabilidade atualizada com sucesso
        schema:
          type: object
      404:
        description: Vulnerabilidade não encontrada
        schema:
          type: object
          properties:
            error:
              type: string
    """
    data = request.json or {}

    vulnerability = data.get("vulnerability")

    if not vulnerability or not isinstance(vulnerability, str):
        return {"error": "Invalid vulnerability"}, 400
    
    result = service.update(external_id, vulnerability)

    if result is None:
        return {"error": "Not found"}, 404
    
    return result

@security_vulnerability_bp.delete("/<string:external_id>")
def delete_security_vulnerability(external_id):
    """
    Deletar vulnerabilidade de segurança
    ---
    tags:
      - SecurityVulnerabilities
    summary: "Delete Security Vulnerability"
    description: "Remove uma vulnerabilidade do sistema"
    parameters:
      - in: path
        name: external_id
        type: string
        required: true
        description: ID único da vulnerabilidade
    responses:
      204:
        description: Vulnerabilidade deletada com sucesso
      404:
        description: Vulnerabilidade não encontrada
        schema:
          type: object
          properties:
            error:
              type: string
      409:
        description: Não pode ser deletada (relacionada com outras entidades)
        schema:
          type: object
          properties:
            error:
              type: string
    """
    result = service.delete(external_id)

    if result is False:
        return {"error": "Not found"}, 404

    if result == "FK":
        return {
            "error": "It cannot be deleted"
        }, 409

    return "", 204

@security_vulnerability_bp.get("/statistics")
def security_vulnerability_statistics():
    """
    Obter estatísticas de vulnerabilidades
    ---
    tags:
      - SecurityVulnerabilities
    summary: "Get Security Vulnerability Statistics"
    description: "Retorna estatísticas e análises sobre as vulnerabilidades"
    responses:
      200:
        description: Estatísticas das vulnerabilidades
        schema:
          type: object
          properties:
            total:
              type: integer
            critical_count:
              type: integer
    """
    return jsonify(service.statistics())